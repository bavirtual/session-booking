{"version":3,"file":"logbook_std.min.js","sources":["../src/logbook_std.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is responsible for registering listeners\n * for logbook std view events.\n *\n * @module     local_booking/logbook_std\n * @author     Mustafa Hajjar (mustafahajjar@gmail.com)\n * @copyright  BAVirtual.co.uk Â© 2023\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n        'jquery',\n        'core/pending',\n        'core/templates',\n        'core/notification',\n        'local_booking/booking_view_manager',\n        'local_booking/modal_actions',\n        'local_booking/events',\n        'local_booking/modal_logentry_form',\n        'local_booking/repository',\n        'local_booking/selectors'\n    ],\n    function(\n        $,\n        Pending,\n        Templates,\n        Notification,\n        ViewManager,\n        ModalActions,\n        BookingEvents,\n        ModalLogentryEditForm,\n        Repository,\n        Selectors\n    ) {\n\n    /**\n     * Register event listeners for session clicks.\n     *\n     * @param {object} root The root element.\n     */\n    const registerEventListeners = (root) => {\n\n        // Listen to logentry created events\n        $('body').on(BookingEvents.logentrycreated, function(e, logentry) {\n            // Refresh logbook\n            refreshNewLogentryContent(root, logentry);\n        });\n\n        // Listen to logentry updated events\n        $('body').on(BookingEvents.logentryupdated, function(e, logentry) {\n            // Refresh logbook\n            refreshLogentryContent(root, logentry);\n        });\n\n        // Listen to logentry deleted event\n        $('body').on(BookingEvents.logentrydeleted, function(e, logentryid) {\n            // Remove logentry from the logbook\n            $('#logentry_' + logentryid).slideUp(300);\n            e.stopImmediatePropagation();\n        });\n\n        // Get promise for the logentry form for create and edit\n        const contextId = $(Selectors.logbookwrapper).data('contextid'),\n        courseId = $(Selectors.logbookwrapper).data('courseid'),\n        userId = $(Selectors.logbookwrapper).data('userid');\n\n        if (contextId) {\n            // Listen the edit click of a logbook entry.\n            root.on('click', Selectors.actions.edit, function(e) {\n                // From logbook\n                const target = e.target;\n                let logegntry = target.closest(Selectors.containers.summaryForm),\n                    logentryId = logegntry.dataset.logentryId;\n\n                // A logentry needs to be edited, show the modal form.\n                e.preventDefault();\n                e.stopPropagation();\n                registerLogentryEditForm(root, e, contextId, courseId, userId, logentryId);\n                e.stopImmediatePropagation();\n            });\n\n            // Listen the edit click of a logbook entry.\n            root.on('click', Selectors.actions.add, function(e) {\n                // A logentry needs to be created, show the modal form.\n                e.preventDefault();\n                e.stopPropagation();\n                registerLogentryAddForm(root, e, contextId, courseId, userId);\n                e.stopImmediatePropagation();\n            });\n        }\n    };\n\n    /**\n     * Refresh the logbook entry edited.\n     *\n     * @method  refreshNewLogentryContent\n     * @param   {object} root     The root element.\n     * @param   {object} logentry The updated logentry.\n     * @return  {promise}\n     */\n    const refreshNewLogentryContent = (root, logentry) => {\n\n        const courseId = $(Selectors.logbookwrapper).data('courseid'),\n        userId = $(Selectors.logbookwrapper).data('userid');\n\n        M.util.js_pending(root.get('id') + '-' + courseId);\n        return Repository.getLogentryById(logentry.id, courseId, userId)\n            .then((response) => {\n                return Templates.render('local_booking/logbook_std_logentry', response.logentry);\n            })\n            .then((html) => {\n                $('#logbook-summary').after(html);\n                root.find('.logbook-shadow1:first').hide().slideDown(300);\n                return;\n            })\n            .always(() => {\n                M.util.js_complete(root.get('id') + '-' + courseId);\n                return;\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Refresh the logbook entry edited.\n     *\n     * @method  refreshLogentryContent\n     * @param   {object} root     The root element.\n     * @param   {object} logentry The updated logentry.\n     * @return  {promise}\n     */\n    const refreshLogentryContent = (root, logentry) => {\n        let card = $('#cardid_' + logentry.id);\n\n        showPlaceholder(card);\n\n        const courseId = $(Selectors.logbookwrapper).data('courseid'),\n        userId = $(Selectors.logbookwrapper).data('userid');\n\n        M.util.js_pending(root.get('id') + '-' + courseId);\n        return Repository.getLogentryById(logentry.id, courseId, userId)\n            .then((response) => {\n                return Templates.render('local_booking/logbook_std_detail', response.logentry);\n            })\n            .then((html, js) => {\n                return Templates.replaceNode(card, html, js);\n            })\n            .always(() => {\n                M.util.js_complete(root.get('id') + '-' + courseId);\n                return showContent(card);\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Register the form and listeners required for\n     * creating logentries.\n     *\n     * @method registerLogentryAddForm\n     * @param  {object} root       The root element.\n     * @param  {object} e          The triggered event.\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     */\n    const registerLogentryAddForm = (root, e, contextId, courseId, userId) => {\n        const LogentryFormPromise = ModalLogentryEditForm.create();\n        const target = e.target;\n        const pendingPromise = new Pending('local_booking/registerLogentryEditForm');\n\n        ViewManager.renderLogentryEditForm(root, e, LogentryFormPromise, target, contextId, courseId, userId,\n            0, true, 'local_booking/logbook_std')\n        .then(pendingPromise.resolve())\n        .catch(window.console.error);\n    };\n\n    /**\n     * Register the form and listeners required for\n     * creating and editing logentries.\n     *\n     * @method registerLogentryEditForm\n     * @param  {object} root       The root element.\n     * @param  {object} e          The triggered event.\n     * @param  {Number} contextId  The course context id of the logentry.\n     * @param  {Number} courseId   The course id of the logentry.\n     * @param  {Number} userId     The user id the logentry belongs to.\n     * @param  {Number} logentryId The logentry id.\n     */\n    const registerLogentryEditForm = (root, e, contextId, courseId, userId, logentryId) => {\n        const LogentryFormPromise = ModalLogentryEditForm.create();\n        const target = e.target;\n        const pendingPromise = new Pending('local_booking/registerLogentryEditForm');\n\n        ViewManager.renderLogentryEditForm(root, e, LogentryFormPromise, target, contextId, courseId, userId,\n            logentryId, false, 'local_booking/logbook_std')\n        .then(pendingPromise.resolve())\n        .catch(window.console.error);\n    };\n\n    /**\n     * Show the empty message when no logentries are found.\n     *\n     * @param {object} card The card element for the logentry view.\n     */\n    const showPlaceholder = function(card) {\n        card.find(Selectors.containers.loadingPlaceholder).removeClass('hidden');\n        card.find(Selectors.containers.content).addClass('hidden');\n    };\n\n    /**\n     * Show the empty message when no logentries are found.\n     *\n     * @param {object} card The card element for the logentry view.\n     */\n    const showContent = function(card) {\n        card.find(Selectors.containers.content).removeClass('hidden');\n        card.find(Selectors.containers.loadingPlaceholder).addClass('hidden');\n    };\n\n    return {\n        init: function(rt) {\n            var root = $(rt);\n            registerEventListeners(root);\n            ModalActions.registerDelete(root);\n            ViewManager.stopLoading(root);\n        }\n    };\n});\n"],"names":["define","$","Pending","Templates","Notification","ViewManager","ModalActions","BookingEvents","ModalLogentryEditForm","Repository","Selectors","refreshNewLogentryContent","root","logentry","courseId","logbookwrapper","data","userId","M","util","js_pending","get","getLogentryById","id","then","response","render","html","after","find","hide","slideDown","always","js_complete","fail","exception","refreshLogentryContent","card","showPlaceholder","js","replaceNode","showContent","registerLogentryAddForm","e","contextId","LogentryFormPromise","create","target","pendingPromise","renderLogentryEditForm","resolve","catch","window","console","error","registerLogentryEditForm","logentryId","containers","loadingPlaceholder","removeClass","content","addClass","init","rt","on","logentrycreated","logentryupdated","logentrydeleted","logentryid","slideUp","stopImmediatePropagation","actions","edit","closest","summaryForm","dataset","preventDefault","stopPropagation","add","registerEventListeners","registerDelete","stopLoading"],"mappings":"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"}